<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Performance Calculator (Google Sheets)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        td a {
            color: #4f46e5;
            text-decoration: underline;
        }
        td a:hover {
            color: #3730a3;
        }
        .stat-circle {
            transition: transform 0.2s ease-in-out;
        }
        .stat-circle:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-full">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Agent Performance Calculator</h1>
            <p class="mt-2 text-lg text-gray-600">Analyze agent performance and company profitability.</p>
        </header>

        <main>
            <!-- Setup Section / Loading Indicator -->
            <div id="loading-section" class="bg-white p-6 rounded-xl shadow-md mb-8 text-center">
                <div class="flex items-center justify-center">
                    <div class="spinner w-8 h-8 rounded-full border-4 border-gray-200"></div>
                    <p id="loading-text" class="ml-3 text-gray-600">Connecting to Google Sheets and fetching latest data...</p>
                </div>
                <div id="errorMessage" class="hidden mt-4 text-center text-red-600 bg-red-100 p-3 rounded-md"></div>
            </div>
            
            <!-- At a Glance Dashboard -->
            <div id="dashboard-section" class="hidden mb-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                    <h2 id="dashboard-title" class="text-2xl font-semibold mb-4 text-gray-800">At a Glance: All Time</h2>
                    <div id="dashboard-circles" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-white text-center">
                        {/* Circles will be dynamically generated here */}
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 id="leaderboard-title" class="text-2xl font-semibold mb-4 text-gray-800">Top Agents: All Time</h2>
                    <div id="agent-leaderboard" class="space-y-4">
                        {/* Leaderboard will be dynamically generated here */}
                    </div>
                </div>
            </div>


            <!-- Calculator Controls -->
            <div id="controls" class="hidden bg-white p-6 rounded-xl shadow-md mb-8">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div id="expenses-section" class="lg:col-span-3 hidden">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Company Expenses</h2>
                        <div id="expenses-list" class="space-y-3">
                            {/* Expenses will be dynamically added here */}
                        </div>
                        <button id="add-expense-btn" class="mt-4 text-sm bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-md hover:bg-gray-300">
                            + Add Custom Expense
                        </button>
                    </div>
                    <div class="lg:col-span-2">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Analyze Performance</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                            <div>
                                <label for="agentSelect" class="block text-sm font-medium text-gray-700">Select Agent</label>
                                <select id="agentSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="yearSelect" class="block text-sm font-medium text-gray-700">Select Year</label>
                                <select id="yearSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="monthSelect" class="block text-sm font-medium text-gray-700">Select Month</label>
                                <select id="monthSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md shadow-sm"></select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 border-t pt-6 grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                    <div class="md:col-span-2">
                        <label for="searchInput" class="block text-sm font-medium text-gray-700">Search All Records (by Load # or Carrier Invoice #)</label>
                         <div class="mt-1 flex gap-2">
                            <input type="text" id="searchInput" class="block w-full border-gray-300 rounded-md shadow-sm" placeholder="e.g., 32628">
                            <button id="searchBtn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700">Search</button>
                        </div>
                    </div>
                    <div class="text-right">
                         <button id="calculateBtn" class="w-full md:w-auto bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-indigo-700">
                            Analyze
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Display Container -->
            <div id="results" class="hidden space-y-8">
                <div id="individual-agent-view" class="bg-white p-6 rounded-xl shadow-md hidden">
                    <h2 id="summaryTitle" class="text-2xl font-semibold mb-4 text-gray-800">Summary</h2>
                    <div id="results-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-center"></div>
                    <div class="mt-4 text-center text-sm text-gray-600"><p id="salaryCalculationNote"></p></div>
                </div>
                <div id="period-total-view" class="bg-white p-6 rounded-xl shadow-md hidden">
                    <h2 id="periodSummaryTitle" class="text-2xl font-semibold mb-4 text-gray-800">Period Grand Total</h2>
                    <div id="period-results-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center"></div>
                    <div id="expenses-summary-view" class="mt-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Expense Breakdown</h3>
                        <div id="expenses-breakdown" class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center text-sm"></div>
                    </div>
                </div>
                <div id="all-agents-view" class="bg-white p-6 rounded-xl shadow-md hidden">
                    <h3 id="allAgentsTitle" class="text-xl font-semibold mb-4 text-gray-800">All Agent Summary</h3>
                     <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agent</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Gross Profit</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Commissionable Gross</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Salary</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Card Payment</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cash Salary</th>
                                </tr>
                            </thead>
                            <tbody id="allAgentsSummaryTable" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                 <div id="search-results-view" class="bg-white p-6 rounded-xl shadow-md hidden">
                    <h3 id="searchResultsTitle" class="text-xl font-semibold mb-4 text-gray-800">Search Results</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead id="searchResultsHeader" class="bg-gray-50"></thead>
                            <tbody id="searchResultsTable" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                <div id="transactions-view" class="bg-white p-6 rounded-xl shadow-md hidden">
                    <h3 id="transactionsTitle" class="text-xl font-semibold mb-4 text-gray-800">Detailed Transactions</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead id="transactionsHeader" class="bg-gray-50"></thead>
                            <tbody id="transactionsTable" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global state
        let allData = [];
        let headersBySheet = {};
        let availableMonthsByYear = {};
        let currentAmdRate = 385;
        let dataPoller = null;
        let lastRawDataState = '';

        // DOM Elements
        const loadingSection = document.getElementById('loading-section');
        const calculateBtn = document.getElementById('calculateBtn');
        const searchBtn = document.getElementById('searchBtn');
        const loadingText = document.getElementById('loading-text');
        const controlsDiv = document.getElementById('controls');
        const resultsDiv = document.getElementById('results');
        const agentSelect = document.getElementById('agentSelect');
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const errorMessageDiv = document.getElementById('errorMessage');
        const allAgentsSummaryTableBody = document.getElementById('allAgentsSummaryTable');
        const expensesSection = document.getElementById('expenses-section');
        const expensesList = document.getElementById('expenses-list');
        const addExpenseBtn = document.getElementById('add-expense-btn');

        // Event Listeners
        window.addEventListener('DOMContentLoaded', handleConnectAndFetch);
        calculateBtn.addEventListener('click', calculateAndDisplayResults);
        searchBtn.addEventListener('click', performSearch);
        yearSelect.addEventListener('change', () => { populateMonthOptions(); loadExpenses(); toggleExpensesVisibility(); });
        monthSelect.addEventListener('change', () => { loadExpenses(); toggleExpensesVisibility(); });
        agentSelect.addEventListener('change', toggleExpensesVisibility);
        addExpenseBtn.addEventListener('click', () => addExpenseRow({ name: '', amount: 0, currency: 'USD' }));
        allAgentsSummaryTableBody.addEventListener('change', (event) => {
            if (event.target.classList.contains('card-payment-checkbox')) {
                const checkbox = event.target;
                const row = checkbox.closest('tr');
                const totalSalaryCell = row.querySelector('.total-salary-cell');
                const cashSalaryCell = row.querySelector('.cash-salary-cell');
                const totalSalary = parseFloat(totalSalaryCell.dataset.value);
                const cardDeduction = 75000 / currentAmdRate;
                cashSalaryCell.textContent = formatCurrency(checkbox.checked ? totalSalary - cardDeduction : totalSalary);
            }
        });
        expensesList.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-expense-btn')) {
                event.target.closest('.expense-row').remove();
            }
        });

        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
        }

        function cleanAndParseFloat(value) {
            if (typeof value === 'number') return isNaN(value) ? 0 : value;
            if (typeof value !== 'string') return 0;
            let str = value.trim();
            if (str === '' || str === '-') return 0;
            const isNegativeAccounting = str.startsWith('(') && str.endsWith(')');
            str = str.replace(/[($),]/g, '');
            let number = parseFloat(str);
            if (isNaN(number)) return 0;
            return isNegativeAccounting ? -Math.abs(number) : number;
        }

        async function handleConnectAndFetch() {
            try {
                await fetchAndProcessData(true); // isInitialLoad = true
                
                if(dataPoller) clearInterval(dataPoller);
                dataPoller = setInterval(pollForDataChanges, 60000); // Check every 60 seconds

            } catch (err) {
                console.error("Error during startup:", err);
                showError(`Error: ${err.result?.error?.message || err.message || 'An unknown error occurred.'}`);
            }
        }

        async function fetchAndProcessData(isInitialLoad = false) {
             try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                if (!response.ok) throw new Error('API response not OK');
                const data = await response.json();
                currentAmdRate = data.rates.AMD || 385;
             } catch (error) {
                 console.warn('Could not fetch exchange rate, using default.', error);
             }

            if (isInitialLoad) loadingText.textContent = 'Connecting to Google Sheets...';
            const apiKey = "AIzaSyDVJBM4d4IMghnmwD4140vOTCSejmBRYkk";
            const sheetUrl = "https://docs.google.com/spreadsheets/d/10A0vVhORkOzumHR6N4aT5EBuIy1fPqq9vaI6FWQffcg/edit?usp=sharing";
            const spreadsheetId = extractSheetId(sheetUrl);

            await loadGapiClient(apiKey);
            if (isInitialLoad) loadingText.textContent = "Fetching sheet names...";
            const sheets = await getSheetNames(spreadsheetId);
            const monthlySheetNames = sheets.filter(s => !s.toUpperCase().includes('AGENT SUMMARY') && !s.toUpperCase().includes('PAYMENT OPTIONS') && !s.toUpperCase().includes('BLANK'));
            if (monthlySheetNames.length === 0) throw new Error("No valid monthly data sheets found.");
            
            if (isInitialLoad) loadingText.textContent = `Fetching data from ${monthlySheetNames.length} sheets...`;
            const allSheetResults = await Promise.all(monthlySheetNames.map(async (sheetName) => ({ sheetName, values: await getSheetData(spreadsheetId, sheetName) })));
            
            const newRawDataString = JSON.stringify(allSheetResults.map(r => r.values));
            
            if (newRawDataString !== lastRawDataState) {
                if(!isInitialLoad) showUpdateNotification();
                lastRawDataState = newRawDataString;
                allData = allSheetResults.flatMap(result => parseMonthlyData(result.values, result.sheetName));
                
                const selections = { agent: agentSelect.value, year: yearSelect.value, month: monthSelect.value };
                populateControls();
                agentSelect.value = selections.agent || 'all';
                yearSelect.value = selections.year || Object.keys(availableMonthsByYear).sort((a,b) => b-a)[0];
                populateMonthOptions();
                monthSelect.value = selections.month || 'all';

                if (!isInitialLoad) {
                    calculateAndDisplayResults(); 
                } else {
                    updateDashboard(allData, "All Time");
                    controlsDiv.classList.remove('hidden');
                    loadingSection.classList.add('hidden');
                }
            }
        }

        async function pollForDataChanges() {
            try {
                await fetchAndProcessData(false);
            } catch (error) {
                console.error("Error polling for data:", error);
            }
        }
        
        function extractSheetId(url) { return url.match(/\/d\/(.*?)\//)?.[1] || url; }
        async function loadGapiClient(apiKey) { return new Promise(resolve => gapi.load('client', async () => { await gapi.client.init({ apiKey, discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] }); resolve(); }));}
        async function getSheetNames(spreadsheetId) { return (await gapi.client.sheets.spreadsheets.get({ spreadsheetId })).result.sheets.map(s => s.properties.title); }
        async function getSheetData(spreadsheetId, range) { return (await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range })).result.values || []; }

        function parseMonthlyData(values, sheetName) {
            if (values.length < 1) return [];
            headersBySheet[sheetName] = values[0];
            const header = values[0].map(h => (h || '').toUpperCase().replace(/\s+/g, ''));
            const records = [];
            const headerMap = {
                load: header.indexOf('LOAD#'), agent: header.indexOf('AGENT'), delDate: header.indexOf('DEL.DATE'),
                buyPrice: header.indexOf('BUYPRICE'), salePrice: header.indexOf('SALEPRICE'), toReceive: header.indexOf('TORECEIVE'),
                globaltranzCharge: header.indexOf('GLOBALTRANZCHARGE'), loadStatus: header.indexOf('LOADSTATUS'),
                ourCarrierMc: header.indexOf('OURCARRIERMC'), carrierInvoice: header.indexOf('CARRIERINVOICE')
            };
            for (let i = 1; i < values.length; i++) {
                const row = values[i];
                const agentName = (row[headerMap.agent] || '').trim(), loadNum = (row[headerMap.load] || '').trim(), delDate = (row[headerMap.delDate] || '').trim();
                if (!agentName || !loadNum || !delDate) continue;
                if (headerMap.loadStatus !== -1 && (row[headerMap.loadStatus] || '').trim().toUpperCase() === 'CANCELLED') continue;
                const buyPrice = cleanAndParseFloat(row[headerMap.buyPrice]), salePrice = cleanAndParseFloat(row[headerMap.salePrice]), toReceive = cleanAndParseFloat(row[headerMap.toReceive]), globaltranzCharge = cleanAndParseFloat(row[headerMap.globaltranzCharge]);
                records.push({
                    rawData: row, agent: agentName, sheetName: sheetName, delDate: delDate, buyPrice: buyPrice,
                    grossProfit: buyPrice - salePrice, grossProfitWithCharge: toReceive - salePrice - globaltranzCharge,
                    factoringFee: buyPrice - toReceive, globaltranzCharge: globaltranzCharge, ourCarrierMc: (row[headerMap.ourCarrierMc] || '').toUpperCase()
                });
            }
            return records;
        }

        function populateControls() {
            agentSelect.innerHTML = '<option value="all">All Agents</option>';
            agentSelect.innerHTML += [...new Set(allData.map(item => item.agent))].sort().map(agent => `<option value="${agent}">${agent}</option>`).join('');
            availableMonthsByYear = [...new Set(allData.map(item => item.sheetName))].reduce((acc, sheetName) => {
                const match = sheetName.toUpperCase().match(/([A-Z]+)\*?(\d{4})/);
                if (match) {
                    const [_, month, year] = match;
                    if (!acc[year]) acc[year] = new Set();
                    acc[year].add(month);
                }
                return acc;
            }, {});
            yearSelect.innerHTML = Object.keys(availableMonthsByYear).sort((a,b) => b - a).map(year => `<option value="${year}">${year}</option>`).join('');
            populateMonthOptions();
            toggleExpensesVisibility();
        }
        
        function populateMonthOptions() {
            const selectedYear = yearSelect.value;
            const months = [...availableMonthsByYear[selectedYear] || []];
            const monthOrder = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
            months.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
            monthSelect.innerHTML = '<option value="all">All Months</option>';
            monthSelect.innerHTML += months.map(month => `<option value="${month}">${month.charAt(0) + month.slice(1).toLowerCase()}</option>`).join('');
            loadExpenses();
        }
        
        function formatCurrency(amount, compact = false) { 
            const options = { style: 'currency', currency: 'USD' };
            if (compact) {
                options.notation = 'compact';
                options.maximumFractionDigits = 1;
            }
            return new Intl.NumberFormat('en-US', options).format(amount || 0); 
        }

        function getAgentSalaryCalculations(agentData) {
            const totalGross = agentData.reduce((s, i) => s + i.grossProfit, 0);
            const netGrossProfit = totalGross - agentData.reduce((s, i) => s + i.globaltranzCharge, 0);
            let agentSalary = 0, commissionableBase = 0;
            if (netGrossProfit > 6000) {
                let factoringFeeBonus = 0, runningGrossProfit = 0, adjustedGpwCBase = 0;
                agentData.forEach(item => { adjustedGpwCBase += item.grossProfitWithCharge + Math.max(0, item.factoringFee - (item.buyPrice * 0.035)); });
                for (const item of agentData) {
                    if (runningGrossProfit >= 12000) factoringFeeBonus += Math.min(item.factoringFee, item.buyPrice * 0.035);
                    runningGrossProfit += item.grossProfit;
                }
                commissionableBase = adjustedGpwCBase + factoringFeeBonus;
                agentSalary = commissionableBase * 0.30;
            } else {
                 let adjustedGpwCBase = 0;
                 agentData.forEach(item => { adjustedGpwCBase += item.grossProfitWithCharge + Math.max(0, item.factoringFee - (item.buyPrice * 0.035)); });
                 commissionableBase = adjustedGpwCBase;
                 agentSalary = commissionableBase * 0.25;
            }
            return { agentSalary, commissionableBase, totalGross };
        }
        
        function calculateAndDisplayResults() {
            ['individual-agent-view', 'period-total-view', 'all-agents-view', 'transactions-view', 'expenses-summary-view', 'search-results-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            const selectedYear = yearSelect.value, selectedMonth = monthSelect.value, selectedAgent = agentSelect.value;
            const periodData = allData.filter(item => {
                const sheetYear = item.sheetName.match(/\d{4}/);
                return sheetYear && sheetYear[0] === selectedYear && (selectedMonth === 'all' || item.sheetName.toUpperCase().startsWith(selectedMonth.toUpperCase()));
            });
            
            saveExpenses();
            const periodText = selectedMonth === 'all' ? `Year ${selectedYear}` : `${selectedMonth.charAt(0) + selectedMonth.slice(1).toLowerCase()} ${selectedYear}`;
            
            updateDashboard(periodData, periodText);

            if (selectedAgent !== 'all') { // --- View 1: Individual Agent ---
                const agentSpecificData = periodData.filter(item => item.agent === selectedAgent);
                const { agentSalary, commissionableBase, totalGross } = getAgentSalaryCalculations(agentSpecificData);
                const totalGPC = agentSpecificData.reduce((s, i) => s + i.grossProfitWithCharge, 0), totalFF = agentSpecificData.reduce((s, i) => s + i.factoringFee, 0), totalGTC = agentSpecificData.reduce((s, i) => s + i.globaltranzCharge, 0);
                const netGP = totalGross - totalGTC;

                document.getElementById('summaryTitle').textContent = `Summary for ${selectedAgent} (${periodText})`;
                document.getElementById('results-summary').innerHTML = `
                    <div class="bg-green-100 p-4 rounded-lg"><p class="text-sm font-medium">Salary</p><p class="text-2xl font-bold">${formatCurrency(agentSalary)}</p></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><p class="text-sm font-medium">Commissionable Gross</p><p class="text-2xl font-bold">${formatCurrency(commissionableBase)}</p></div>
                    <div class="bg-gray-100 p-4 rounded-lg"><p class="text-sm font-medium">Gross Profit</p><p class="text-2xl font-bold">${formatCurrency(totalGross)}</p></div>
                     <div class="bg-gray-100 p-4 rounded-lg"><p class="text-sm font-medium">Gross Profit w/ Charge</p><p class="text-2xl font-bold">${formatCurrency(totalGPC)}</p></div>
                    <div class="bg-red-100 p-4 rounded-lg"><p class="text-sm font-medium">GlobalTranz Charge</p><p class="text-2xl font-bold">${formatCurrency(totalGTC)}</p></div>
                    <div class="bg-yellow-100 p-4 rounded-lg"><p class="text-sm font-medium">Factoring Fees</p><p class="text-2xl font-bold">${formatCurrency(totalFF)}</p></div>`;
                document.getElementById('salaryCalculationNote').textContent = netGP > 6000 ? `Agent qualifies for 30% commission (Net GP > $6k).` : `Agent's Net GP (${formatCurrency(netGP)}) is below $6k, qualifying for 25% commission.`;
                
                const sheetForHeaders = allData.find(d => agentSpecificData[0]?.sheetName === d.sheetName)?.sheetName || periodData[0]?.sheetName;
                const headers = headersBySheet[sheetForHeaders] || [];
                document.getElementById('transactionsHeader').innerHTML = `<tr>${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`).join('')}</tr>`;
                document.getElementById('transactionsTable').innerHTML = agentSpecificData.map(item => `<tr>${item.rawData.map(cell => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(cell||'').startsWith('http') ? `<a href="${cell}" target="_blank" rel="noopener noreferrer">Link</a>` : cell || ''}</td>`).join('')}</tr>`).join('');
                document.getElementById('transactionsTitle').textContent = `Detailed Transactions for ${selectedAgent} (${periodText})`;

                document.getElementById('individual-agent-view').classList.remove('hidden');
                document.getElementById('transactions-view').classList.remove('hidden');
            } else { // --- Views for "All Agents" ---
                 const { grandTotals, expenses } = calculatePeriodTotals(periodData);
                 
                document.getElementById('periodSummaryTitle').textContent = `Grand Total Summary for ${periodText}`;
                document.getElementById('period-results-summary').innerHTML = `
                    <div class="bg-purple-100 p-4 rounded-lg"><p class="text-sm font-medium">Company Net Profit</p><p class="text-2xl font-bold">${formatCurrency(grandTotals.companyNetProfit)}</p></div>
                    <div class="bg-green-100 p-4 rounded-lg"><p class="text-sm font-medium">Total Payouts</p><p class="text-2xl font-bold">${formatCurrency(grandTotals.totalPayouts)}</p></div>
                    <div class="bg-gray-100 p-4 rounded-lg"><p class="text-sm font-medium">Total Gross Profit</p><p class="text-2xl font-bold">${formatCurrency(grandTotals.gp)}</p></div>
                    <div class="bg-gray-100 p-4 rounded-lg"><p class="text-sm font-medium">Total Gross Profit w/ Charge</p><p class="text-2xl font-bold">${formatCurrency(grandTotals.gpc)}</p></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><p class="text-sm font-medium">Total Commissionable Gross</p><p class="text-2xl font-bold">${formatCurrency(grandTotals.commBase)}</p></div>
                    <div class="bg-yellow-100 p-4 rounded-lg"><p class="text-sm font-medium">Total Factoring / QP Fees</p><p class="text-2xl font-bold">${formatCurrency(grandTotals.ff)}</p></div>
                    <div class="bg-red-100 p-4 rounded-lg"><p class="text-sm font-medium">Total GlobalTranz Charge</p><p class="text-2xl font-bold">${formatCurrency(grandTotals.gtc)}</p></div>`;
                
                document.getElementById('expenses-breakdown').innerHTML = `
                    <div class="bg-gray-50 p-2 rounded-lg"><p class="font-medium text-gray-800">Agent Salaries</p><p class="text-gray-600">${formatCurrency(grandTotals.salary)}</p></div>
                    <div class="bg-gray-50 p-2 rounded-lg"><p class="font-medium text-gray-800">Manager Fee</p><p class="text-gray-600">${formatCurrency(expenses.managerFee)}</p></div>
                    <div class="bg-gray-50 p-2 rounded-lg"><p class="font-medium text-gray-800">Support Fee</p><p class="text-gray-600">${formatCurrency(expenses.supportFee)}</p></div>
                    <div class="bg-gray-50 p-2 rounded-lg"><p class="font-medium text-gray-800">Posting Fee 1</p><p class="text-gray-600">${formatCurrency(expenses.postingGuy1Fee)}</p></div>
                    <div class="bg-gray-50 p-2 rounded-lg"><p class="font-medium text-gray-800">Posting Fee 2</p><p class="text-gray-600">${formatCurrency(expenses.postingGuy2Fee)}</p></div>
                    <div class="bg-gray-50 p-2 rounded-lg"><p class="font-medium text-gray-800">Custom</p><p class="text-gray-600">${formatCurrency(expenses.customExpenses)}</p></div>
                `;
                
                document.getElementById('allAgentsTitle').textContent = `All Agent Summary for ${periodText}`;
                allAgentsSummaryTableBody.innerHTML = grandTotals.agentCalcs.map(({ agent, agentSalary, commissionableBase, totalGross }) => {
                    const cashSalary = agentSalary - (75000 / currentAmdRate);
                    return `<tr>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${agent}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${formatCurrency(totalGross)}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${formatCurrency(commissionableBase)}</td>
                        <td class="px-6 py-4 text-sm font-semibold text-gray-800 total-salary-cell" data-value="${agentSalary}">${formatCurrency(agentSalary)}</td>
                        <td class="px-6 py-4 text-center text-sm"><input type="checkbox" checked class="card-payment-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded"></td>
                        <td class="px-6 py-4 text-sm font-semibold text-green-700 cash-salary-cell">${formatCurrency(cashSalary)}</td>
                    </tr>`;
                }).join('');
                
                document.getElementById('period-total-view').classList.remove('hidden');
                document.getElementById('expenses-summary-view').classList.remove('hidden');
                document.getElementById('all-agents-view').classList.remove('hidden');
            }
            resultsDiv.classList.remove('hidden');
        }

        function calculatePeriodTotals(periodData) {
            let grandTotals = { gp: 0, gpc: 0, ff: 0, gtc: 0, commBase: 0, salary: 0 };
            const agentsInPeriod = [...new Set(periodData.map(item => item.agent))].sort();
            const agentCalcs = agentsInPeriod.map(agent => {
                const agentData = periodData.filter(item => item.agent === agent);
                const calcs = getAgentSalaryCalculations(agentData);
                const agentGPC = agentData.reduce((s, i) => s + i.grossProfitWithCharge, 0);
                grandTotals.gp += calcs.totalGross;
                grandTotals.gpc += agentGPC;
                grandTotals.ff += agentData.reduce((s, i) => s + i.factoringFee, 0);
                grandTotals.gtc += agentData.reduce((s, i) => s + i.globaltranzCharge, 0);
                grandTotals.commBase += calcs.commissionableBase;
                grandTotals.salary += calcs.agentSalary;
                return { agent, ...calcs, totalGPC: agentGPC };
            });

            // Calculate additional expenses
            const expenses = { supportFee: 0, postingGuy1Fee: 0, postingGuy2Fee: 0, managerFee: 0, customExpenses: 0 };
            document.querySelectorAll('.expense-row').forEach(row => {
                const name = row.querySelector('.expense-name').value.toLowerCase();
                const amount = cleanAndParseFloat(row.querySelector('.expense-amount').value);
                const currency = row.querySelector('.expense-currency').value;
                const usdAmount = currency === 'AMD' ? amount / currentAmdRate : amount;

                if(name.includes('support')) expenses.supportFee += usdAmount;
                else if(name.includes('posting fee 1')) expenses.postingGuy1Fee += usdAmount;
                else if(name.includes('posting fee 2')) {
                    const globalLoadsGPwC = periodData.filter(d => d.ourCarrierMc.includes('GLOBAL')).reduce((sum, item) => sum + item.grossProfitWithCharge, 0);
                    expenses.postingGuy2Fee += usdAmount + (globalLoadsGPwC * 0.02);
                }
                else expenses.customExpenses += usdAmount;
            });
            
            const managerBonus = (grandTotals.gpc > 40000) ? (grandTotals.gpc * 0.04) : (grandTotals.gp * 0.02);
            expenses.managerFee = 1000 + managerBonus;
            
            grandTotals.totalPayouts = grandTotals.salary + expenses.managerFee + expenses.supportFee + expenses.postingGuy1Fee + expenses.postingGuy2Fee + expenses.customExpenses;
            grandTotals.companyNetProfit = grandTotals.gpc - grandTotals.totalPayouts;
            grandTotals.agentCalcs = agentCalcs.sort((a,b) => b.totalGPC - a.totalGPC);

            return { grandTotals, expenses };
        }

        function updateDashboard(data, periodText) {
            document.getElementById('dashboard-section').classList.remove('hidden');
            const { grandTotals } = calculatePeriodTotals(data);
            
            document.getElementById('dashboard-title').textContent = `At a Glance: ${periodText}`;
            document.getElementById('leaderboard-title').textContent = `Top Agents by GP w/ Charge: ${periodText}`;

            document.getElementById('dashboard-circles').innerHTML = `
                <div title="Company Net Profit" class="stat-circle bg-purple-600 p-4 rounded-full flex flex-col justify-center aspect-square"><span class="text-xs font-medium">Net Profit</span><span class="font-bold text-lg">${formatCurrency(grandTotals.companyNetProfit, true)}</span></div>
                <div title="Total Payouts" class="stat-circle bg-green-600 p-4 rounded-full flex flex-col justify-center aspect-square"><span class="text-xs font-medium">Payouts</span><span class="font-bold text-lg">${formatCurrency(grandTotals.totalPayouts, true)}</span></div>
                <div title="Total Gross Profit" class="stat-circle bg-gray-700 p-4 rounded-full flex flex-col justify-center aspect-square"><span class="text-xs font-medium">Gross Profit</span><span class="font-bold text-lg">${formatCurrency(grandTotals.gp, true)}</span></div>
                <div title="Total Gross Profit w/ Charge" class="stat-circle bg-gray-500 p-4 rounded-full flex flex-col justify-center aspect-square"><span class="text-xs font-medium">GP w/ Charge</span><span class="font-bold text-lg">${formatCurrency(grandTotals.gpc, true)}</span></div>
                <div title="Total Commissionable Gross" class="stat-circle bg-blue-600 p-4 rounded-full flex flex-col justify-center aspect-square"><span class="text-xs font-medium">Comm. Gross</span><span class="font-bold text-lg">${formatCurrency(grandTotals.commBase, true)}</span></div>
                <div title="Total Factoring / QP Fees" class="stat-circle bg-yellow-500 p-4 rounded-full flex flex-col justify-center aspect-square"><span class="text-xs font-medium">Factoring</span><span class="font-bold text-lg">${formatCurrency(grandTotals.ff, true)}</span></div>
                <div title="Total GlobalTranz Charge" class="stat-circle bg-red-600 p-4 rounded-full flex flex-col justify-center aspect-square"><span class="text-xs font-medium">GTZ Charge</span><span class="font-bold text-lg">${formatCurrency(grandTotals.gtc, true)}</span></div>
            `;
            
            const leaderboardContainer = document.getElementById('agent-leaderboard');
            leaderboardContainer.innerHTML = grandTotals.agentCalcs.slice(0, 3).map((agent, index) => `
                <div class="flex items-center">
                    <img src="https://i.pravatar.cc/40?u=${agent.agent.replace(/\s+/g, '')}" alt="${agent.agent}" class="w-10 h-10 rounded-full mr-4">
                    <div>
                        <p class="font-semibold text-gray-800">${index + 1}. ${agent.agent}</p>
                        <p class="text-sm text-gray-600">GP w/ Charge: ${formatCurrency(agent.totalGPC)}</p>
                    </div>
                </div>
            `).join('');
            if (grandTotals.agentCalcs.length === 0) {
                leaderboardContainer.innerHTML = `<p class="text-sm text-gray-500">No agent data for this period.</p>`;
            }
        }

        function performSearch() {
            ['individual-agent-view', 'period-total-view', 'all-agents-view', 'transactions-view', 'expenses-summary-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
            const searchResultsView = document.getElementById('search-results-view'), searchResultsTable = document.getElementById('searchResultsTable'), searchResultsHeader = document.getElementById('searchResultsHeader');
            const searchTerm = document.getElementById('searchInput').value.trim().toUpperCase();
            if (!searchTerm) { searchResultsView.classList.add('hidden'); return; }
            const results = allData.filter(item => {
                const loadNum = (item.rawData[headersBySheet[item.sheetName].map(h => (h||'').toUpperCase().replace(/\s+/g, '')).indexOf('LOAD#')] || '').toUpperCase();
                const invoiceNum = (item.rawData[headersBySheet[item.sheetName].map(h => (h||'').toUpperCase().replace(/\s+/g, '')).indexOf('CARRIERINVOICE')] || '').toUpperCase();
                return loadNum.includes(searchTerm) || invoiceNum.includes(searchTerm);
            });
            document.getElementById('searchResultsTitle').textContent = `Search Results for "${searchTerm}" (${results.length} found)`;
            if (results.length > 0) {
                const headers = headersBySheet[results[0].sheetName] || [];
                searchResultsHeader.innerHTML = `<tr>${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`).join('')}</tr>`;
                searchResultsTable.innerHTML = results.map(item => `<tr>${item.rawData.map(cell => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(cell||'').startsWith('http') ? `<a href="${cell}" target="_blank" rel="noopener noreferrer">Link</a>` : cell || ''}</td>`).join('')}</tr>`).join('');
            } else {
                 searchResultsHeader.innerHTML = '';
                 searchResultsTable.innerHTML = `<tr><td class="text-center py-4">No records found.</td></tr>`;
            }
            resultsDiv.classList.remove('hidden');
            searchResultsView.classList.remove('hidden');
        }
        
        // --- Expense Management Functions ---
        function getExpensesKey() { return `expenses_${yearSelect.value}_${monthSelect.value}`; }
        function saveExpenses() {
            if (agentSelect.value !== 'all') return;
            const expenses = Array.from(document.querySelectorAll('.expense-row')).map(row => ({ name: row.querySelector('.expense-name').value, amount: row.querySelector('.expense-amount').value, currency: row.querySelector('.expense-currency').value }));
            localStorage.setItem(getExpensesKey(), JSON.stringify(expenses));
        }
        function loadExpenses() {
            expensesList.innerHTML = '';
            const key = getExpensesKey();
            const savedExpenses = JSON.parse(localStorage.getItem(key));
            const defaultExpenses = [ { name: 'Support Fee', amount: 1300, currency: 'USD' }, { name: 'Posting Fee 1', amount: 1000, currency: 'USD' }, { name: 'Posting Fee 2', amount: 350000, currency: 'AMD' } ];
            (savedExpenses || defaultExpenses).forEach(expense => addExpenseRow(expense));
        }
        function addExpenseRow({ name, amount, currency }) {
            const row = document.createElement('div');
            row.className = 'expense-row grid grid-cols-12 gap-2 items-center';
            row.innerHTML = `
                <div class="col-span-4"><input type="text" value="${name}" class="expense-name w-full border-gray-300 rounded-md shadow-sm text-sm" placeholder="Expense Name"></div>
                <div class="col-span-3"><input type="number" value="${amount}" class="expense-amount w-full border-gray-300 rounded-md shadow-sm text-sm"></div>
                <div class="col-span-3">
                    <select class="expense-currency w-full border-gray-300 rounded-md shadow-sm text-sm">
                        <option value="USD" ${currency === 'USD' ? 'selected' : ''}>USD</option>
                        <option value="AMD" ${currency === 'AMD' ? 'selected' : ''}>AMD</option>
                    </select>
                </div>
                <div class="col-span-2 text-right">
                    <button class="remove-expense-btn text-red-500 hover:text-red-700 text-sm font-semibold">Remove</button>
                </div>
            `;
            expensesList.appendChild(row);
        }
        
        function toggleExpensesVisibility() {
            const showExpenses = agentSelect.value === 'all' && monthSelect.value !== 'all';
            expensesSection.classList.toggle('hidden', !showExpenses);
        }

        function showUpdateNotification() {
            let notification = document.getElementById('update-notification');
            if(!notification) {
                notification = document.createElement('div');
                notification.id = 'update-notification';
                notification.className = 'fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 z-50';
                document.body.appendChild(notification);
            }
            notification.textContent = 'Sheet data has been updated automatically!';
            notification.style.opacity = '1';
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 4000);
        }

    </script>
</body>
</html>

